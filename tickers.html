<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTC/ETH Tickers</title>
    <style>
        body {
            font-family: Verdana, monospace;
            background: #000;
            color: #fffdd0;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2rem;
        }
        .clocks {
            display: flex;
            flex-direction: row;
            gap: 2rem;
        }
        .clock {
            text-align: right;
        }
        .clock-label {
            font-size: 0.8rem;
            opacity: 0.5;
        }
        .seconds {
            font-size: 1rem;
            opacity: 0.5;
        }
        .local-clock {
            display: none;
        }
        .clock-value {
            font-size: 1.5rem;
            font-weight: 900;
        }
        .tickers {
            display: grid;
            grid-template-columns: 1fr 1fr;
            text-align: right;
            gap: 0.5rem;
        }
        .price {
            font-size: 3.5rem;
            font-weight: 900;
        }
        .positions {
            display: none;
            font-size: 1rem;
        }
        .positions.active {
            display: block;
        }
        .positions table {
            border-collapse: collapse;
        }
        .positions th, .positions td {
            padding: 0.3rem 0.5rem;
            text-align: right;
        }
        .positions th {
            opacity: 0.5;
            font-weight: normal;
        }
        .positions td:first-child, .positions th:first-child {
            text-align: left;
        }
        .positive { color: #4ade80; }
        .negative { color: #f87171; }
        .wide-only {
            display: none;
        }
        @media (min-width: 1200px) {
            body {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: space-between;
                align-content: center;
                padding: 0 3rem;
                gap: 3rem;
            }
            .local-clock {
                display: block;
            }
            .clocks {
                gap: 3rem;
            }
            .clock {
                text-align: left;
            }
            .clock-value {
                font-size: 3.5rem;
            }
            .tickers {
                display: flex;
                flex-direction: row;
                gap: 3rem;
            }
            .price {
                font-size: 3.5rem;
            }
            .positions {
                width: 100%;
                font-size: 1.8rem;
            }
            .positions th, .positions td {
                padding: 0.5rem 1.5rem;
            }
            .wide-only {
                display: table-cell;
            }
        }
    </style>
</head>
<body>
    <div class="clocks">
        <div class="clock local-clock">
            <div class="clock-label">Local</div>
            <div class="clock-value" id="local">--:--</div>
        </div>
        <div class="clock">
            <div class="clock-label">UTC</div>
            <div class="clock-value" id="utc">--:--</div>
        </div>
        <div class="clock">
            <div class="clock-label">New York</div>
            <div class="clock-value" id="ny">--:--</div>
        </div>
        <div class="clock">
            <div class="clock-label">&nbsp;</div>
            <div class="clock-value">:<span class="seconds" id="sec">--</span></div>
        </div>
    </div>
    <div class="tickers">
        <div>
            <div class="price" id="btc">--</div>
        </div>
        <div>
            <div class="price" id="eth">--</div>
        </div>
        <div>
            <div class="price" id="sol">--</div>
        </div>
        <div>
            <div class="price" id="xrp">--</div>
        </div>
    </div>
    <div class="positions" id="positions"></div>

    <script>
        const btc = document.getElementById('btc');
        const eth = document.getElementById('eth');
        const sol = document.getElementById('sol');
        const xrp = document.getElementById('xrp');
        const localEl = document.getElementById('local');
        const utcEl = document.getElementById('utc');
        const nyEl = document.getElementById('ny');
        const secEl = document.getElementById('sec');
        const positionsEl = document.getElementById('positions');
        
        const urlParams = new URLSearchParams(window.location.search);
        const walletAddress = urlParams.get('wallet');
        
        let positionsHidden = false;
        let cachedPositionsHtml = '';
        
        document.addEventListener('click', () => {
            positionsHidden = !positionsHidden;
            if (positionsHidden) {
                positionsEl.querySelectorAll('td').forEach(td => td.textContent = '***');
            } else if (cachedPositionsHtml) {
                positionsEl.innerHTML = cachedPositionsHtml;
            }
        });
        
        function fmt(p) {
            return parseFloat(p).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        function formatTime(date, timeZone) {
            const opts = { hour: '2-digit', minute: '2-digit', hour12: false };
            if (timeZone) opts.timeZone = timeZone;
            const time = date.toLocaleTimeString('en-GB', opts);
            const [h, m] = time.split(':');
            return { h, m };
        }

        function updateClocks() {
            const now = new Date();
            const local = formatTime(now);
            const utc = formatTime(now, 'UTC');
            const ny = formatTime(now, 'America/New_York');
            
            localEl.textContent = local.h + ':' + local.m;
            utcEl.textContent = utc.h + ':' + utc.m;
            nyEl.textContent = ny.h + ':' + ny.m;
            secEl.textContent = now.getUTCSeconds().toString().padStart(2, '0');
        }
        updateClocks();
        setInterval(updateClocks, 1000);

        function connect() {
            const ws = new WebSocket('wss://fstream.binance.com/stream?streams=btcusdt@ticker/ethusdt@ticker/solusdt@ticker/xrpusdt@ticker');
            ws.onmessage = (e) => {
                const d = JSON.parse(e.data).data;
                if (d.s === 'BTCUSDT') btc.textContent = fmt(d.c);
                else if (d.s === 'ETHUSDT') eth.textContent = fmt(d.c);
                else if (d.s === 'SOLUSDT') sol.textContent = parseFloat(d.c).toFixed(2);
                else if (d.s === 'XRPUSDT') xrp.textContent = parseFloat(d.c).toFixed(3);
            };
            ws.onclose = () => setTimeout(connect, 3000);
            ws.onerror = () => ws.close();
        }
        connect();

        function fmtPnl(val) {
            const n = parseFloat(val);
            const cls = n >= 0 ? 'positive' : 'negative';
            const sign = n >= 0 ? '+' : '';
            return `<span class="${cls}">${sign}${n.toFixed(2)}</span>`;
        }

        function fmtPrice(val) {
            const n = parseFloat(val);
            const intDigits = Math.floor(Math.abs(n)).toString().length;
            const decimals = Math.max(0, 5 - intDigits);
            return n.toLocaleString('en-US', {minimumFractionDigits: decimals, maximumFractionDigits: decimals});
        }

        async function fetchPositions() {
            if (!walletAddress) return;
            
            try {
                const res = await fetch('https://api.hyperliquid.xyz/info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'clearinghouseState', user: walletAddress })
                });
                const data = await res.json();
                
                if (data.assetPositions && data.assetPositions.length > 0) {
                    positionsEl.classList.add('active');
                    let html = '<table><tr><th>Size</th><th>Value</th><th>Margin</th><th>Entry</th><th class="wide-only">Liq</th><th>PnL</th><th>Funding</th></tr>';
                    
                    for (const ap of data.assetPositions) {
                        const p = ap.position;
                        const size = parseFloat(p.szi);
                        if (size === 0) continue;
                        const pnl = parseFloat(p.unrealizedPnl);
                        const margin = parseFloat(p.marginUsed);
                        const initialMargin = margin - pnl;
                        const roe = initialMargin > 0 ? (pnl / initialMargin) * 100 : 0;
                        const roeCls = roe >= 0 ? 'positive' : 'negative';
                        const roeSign = roe >= 0 ? '+' : '';
                        const sizeCls = size >= 0 ? 'positive' : 'negative';
                        const liqPx = p.liquidationPx ? fmtPrice(p.liquidationPx) : '-';
                        
                        html += `<tr>
                            <td class="${sizeCls}">${size.toFixed(4)} ${p.coin}</td>
                            <td>${parseFloat(p.positionValue).toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                            <td>${margin.toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                            <td>${fmtPrice(p.entryPx)}</td>
                            <td class="wide-only">${liqPx}</td>
                            <td>${fmtPnl(pnl)} <span class="${roeCls}">(${roeSign}${roe.toFixed(1)}%)</span></td>
                            <td>${fmtPnl(-parseFloat(p.cumFunding.sinceOpen))}</td>
                        </tr>`;
                    }
                    html += '</table>';
                    cachedPositionsHtml = html;
                    if (!positionsHidden) {
                        positionsEl.innerHTML = html;
                    }
                }
            } catch (err) {
                console.error('Failed to fetch positions:', err);
            }
        }

        if (walletAddress) {
            fetchPositions();
            setInterval(fetchPositions, 5000);
        }
    </script>
</body>
</html>

